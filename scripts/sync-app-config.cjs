#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const { resolveAppEnv } = require('../config/app-env');

const repoRoot = path.resolve(__dirname, '..');
const runtimeConfigPath = path.join(
  repoRoot,
  'frontend',
  'public',
  'runtime-config.js',
);

function buildRuntimeConfig(env) {
  const banner =
    '// This file is auto-generated by scripts/sync-app-config.cjs\n' +
    '// Do not edit manually. Update backend-nestjs/.env or Docker env vars instead.\n';

  const payload = JSON.stringify(
    {
      BASE_URL: env.baseUrl,
      FRONTEND_URL: env.frontendUrl,
      BACKEND_URL: env.backendUrl,
      API_URL: env.apiUrl,
      FRONTEND_PORT: env.frontendPort,
      BACKEND_PORT: env.backendPort,
      SOURCE: env.source || 'unknown',
      GENERATED_AT: new Date().toISOString(),
    },
    null,
    2,
  );

  return `${banner}(function bootstrapRuntimeConfig(globalScope){\n  const env = ${payload};\n  const target = (globalScope.ENV = globalScope.ENV || {});\n  for (const [key, value] of Object.entries(env)) {\n    if (value) {\n      target[key] = value;\n    }\n  }\n  globalScope.CONFIG = Object.assign(globalScope.CONFIG || {}, target);\n})(typeof window !== 'undefined' ? window : globalThis);\n`;
}

function main() {
  try {
    const env = resolveAppEnv();
    const content = buildRuntimeConfig(env);
    fs.writeFileSync(runtimeConfigPath, content, 'utf8');
    console.log(
      `runtime-config.js updated -> ${env.backendUrl} (source: ${env.source})`,
    );
  } catch (error) {
    console.error('Failed to sync runtime config:', error);
    process.exitCode = 1;
  }
}

if (require.main === module) {
  main();
}
